[tox]
envlist =
    py39, py310, py311, py312, py313, py314,
    lint, typing, security, integration, docs, all
isolated_build = true
skip_missing_interpreters = true
skipsdist = true

[testenv]
description = Run unit tests with coverage
commands =
    pip install -e .[test]
    python -m coverage run --branch -m pytest --tb=short -W error
    python -m coverage report -m
    python -m coverage xml -o coverage.xml
    python -m coverage html

[testenv:lint]
description = Run code format and lint checks
basepython = python3.12
skip_install = true
deps =
    black
    isort
    pylint
commands =
    black --check --diff src tests
    isort --check-only --diff src tests
    pylint src --fail-under=10.0

[testenv:typing]
description = Run static type checks
basepython = python3.12
deps =
    mypy
commands =
    pip install -e .[test]
    python -m mypy src

[testenv:security]
description = Run security scans
basepython = python3.12
skip_install = true
deps =
    bandit
commands =
    bandit -r src

[testenv:docs]
description = Build docs
basepython = python3.12
commands =
    pip install -e .[docs]
    sphinx-apidoc -o docs/source src/reqivo --force --no-toc --module-first -t docs/source/_templates/apidoc
    sphinx-build -W -n --keep-going -b html docs/source docs/_build/html

[testenv:integration]
description = Run integration tests only
deps =
    pytest
    pytest-asyncio
commands =
    pip install -e .
    python -m pytest tests/integration/ -v

[testenv:all]
description = Run tests + lint + typing + security (single interpreter)
basepython = python3.12
deps =
    black
    isort
    pylint
    mypy
    bandit
commands =
    pip install -e .[test]
    python -m coverage run --branch -m pytest --tb=short -W error
    python -m coverage report -m
    python -m coverage xml -o coverage.xml
    black --check --diff src tests
    isort --check-only --diff src tests
    pylint src --fail-under=10.0
    python -m mypy src
    bandit -r src
