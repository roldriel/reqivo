[tox]
envlist =
    py39, py310, py311, py312,
    lint, typing, security, integration, docs, all
isolated_build = true
skip_missing_interpreters = true
skipsdist = true

[testenv]
description = Run unit tests with coverage
allowlist_externals =
    coverage
extras =
    test
commands =
    coverage run --branch -m pytest --tb=short --disable-warnings
    coverage report -m
    coverage html

[testenv:lint]
description = Run code format and lint checks
basepython = python3.12
skip_install = true
deps =
    black
    isort
    pylint
allowlist_externals =
    black
    isort
    pylint
commands =
    black --check --diff src tests
    isort --check-only --diff src tests
    pylint src --fail-under=8

[testenv:typing]
description = Run static type checks
basepython = python3.12
extras =
    test
deps =
    mypy
commands =
    python -m mypy src

[testenv:security]
description = Run security scans
basepython = python3.12
skip_install = true
deps =
    bandit
allowlist_externals =
    bandit
commands =
    bandit -r src

[testenv:docs]
description = Build docs
basepython = python3.12
extras =
    docs
allowlist_externals =
    sphinx-apidoc
    sphinx-build
commands =
    sphinx-apidoc -o docs/source src/reqivo --force --no-toc --module-first -t docs/source/_templates/apidoc
    sphinx-build -b html docs/source docs/_build/html

[testenv:integration]
description = Run integration tests only
deps =
    pytest
    pytest-asyncio
commands =
    pip install -e .
    python -m pytest tests/integration/ -v

[testenv:all]
description = Run tests + lint + typing + security (single interpreter)
basepython = python3.12
extras =
    test
deps =
    black
    isort
    pylint
    mypy
    bandit
allowlist_externals =
    black
    isort
    pylint
    bandit
    coverage
commands =
    pip install -e .
    coverage run --branch -m pytest --tb=short --disable-warnings
    coverage report -m
    black --check --diff src tests
    isort --check-only --diff src tests
    pylint src --fail-under=8
    python -m mypy src
    bandit -r src
